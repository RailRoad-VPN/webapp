"use strict";const LS_ORDER_KEY="order",LS_ORDER_PACK_ID_KEY="pack_id",LS_ORDER_ACCOUNT_KEY="account",LS_ORDER_ACCOUNT_EMAIL_KEY="email",LS_ORDER_ACCOUNT_PASSWORD_KEY="password",LS_ORDER_ACCOUNT_PASSWORD_CONFIRM_KEY="password_confirm";$(window).on("load",function(){const m=$("meta#profile_page_url");const r=$("meta#email_check_url");const l=$("meta#is_trial_available_url");const t=$("meta#chosen_sub_url");const q=$("meta#choose_service_pack_url");const f=$("#subscriptionsData");const s=$(".order-form");const e=$("#user_uuid");const z=$("#pack_id");const o=$("#email-input");const A=$("#password-input");const n=$("#repeat-password-input");const g=$("#payment_methods-modal");let VPN_FREE,VPN_TRIAL,UNDERSCORE_CHOSEN_SUB_TMPLT,USER_REGISTERED,ORDER_LS,CHOSEN_PACK,ACCOUNT_LS;blockPage(null,v);$(".order-progress-step").on("click",function(){const C=$(this).data("id");p(null,C);analytics_action("order_progress_step_click")});$(".btn-checkout").on("click",function(){CHOSEN_PACK=$(this).data("id");z.val(CHOSEN_PACK);d(CHOSEN_PACK,function(){p("right")});analytics_action("pack_checkout_button")});$(document).on("click",".order-form .btn-next",function(){p("right");analytics_action("order_next_button")});$(document).on("click",".order-form .btn-previous",function(){p("left");analytics_action("order_back_button")});$('.order-form input[type="text"], .order-form input[type="password"], .order-form textarea').on("focus",function(){markInput($(this),true)});$('input[type="text"], input[type="password"]').on("focus",function(){$(this).parent().find(".error").hide()});function p(E,F){let $currentStep=$(".order-form").find(".order-progress-step.active");let currentStepId=$currentStep.data("id");if(!F||F===""){if(E==="left"){F=$currentStep.prev().data("id")}else{F=$currentStep.next().data("id")}}let $newStep=$('.order-progress-step[data-id="'+F+'"]');let $newStepFieldset=$('fieldset[data-id="'+F+'"]');let $currentStepFieldset=$('fieldset[data-id="'+currentStepId+'"]');const D=$newStep.data("num"),C=$currentStep.data("num");let byStep=false;if(!E){byStep=true;if(parseInt(D)>parseInt(C)){E="right"}}if(E==="right"){if(currentStepId==="pack"){B(function(){u($currentStepFieldset,$currentStep,$newStep,E,$newStepFieldset,C,D,byStep)})}else{if(currentStepId==="account"){c(function(){u($currentStepFieldset,$currentStep,$newStep,E,$newStepFieldset,C,D,byStep)})}}}else{u($currentStepFieldset,$currentStep,$newStep,E,$newStepFieldset,C,D,byStep)}}function u(H,J,E,I,F,C,D,G){if(I==="right"){J.addClass("activated")}else{J.removeClass("activated")}if(G){for(let i=0;i<=D;i++){$('.order-progress-step[data-num="'+i+'"]').addClass("activated")}if(D<C){for(let i=D;i<=C;i++){$('.order-progress-step[data-num="'+i+'"]').removeClass("activated")}}}k(C,D);H.fadeOut(400,function(){J.removeClass("active");E.addClass("active").removeClass("activated");F.fadeIn();scrollToTop()})}function k(C,E){const D=$("#progress-bar");const G=D.data("number-of-steps");const F=100/G;let new_value=E*F;D.attr("style","width: "+new_value+"%;").data("now-value",new_value)}function B(E){const C=f.data("dict");const F=C[CHOSEN_PACK];if(!F){p(null,"pack");return false}try{$(".chosen-subscription-name").text(F.service_name)}catch(D){p(null,"pack");return false}F.features=[];let $featuresHtml=$(".subscription-"+F.id).filter(function(){return $(this).css("display")==="block"});$featuresHtml.find("ul.pricing-content span").each(function(){const G={name:$(this).text(),enabled:!$(this).parent().hasClass("no-feature")};let chosensubFeatures=F.features;chosensubFeatures.push(G)});let subJSON={chosen_subscription:F,width:"width: 18rem;"};let html=UNDERSCORE_CHOSEN_SUB_TMPLT(subJSON);$(".chosen-subscription").html(html);subJSON={chosen_subscription:C[CHOSEN_PACK],width:""};html=UNDERSCORE_CHOSEN_SUB_TMPLT(subJSON);$(".chosen-subscription-mini").html(html);j(E);analytics_checkout_step(1,"pack","CHOSEN_PACK")}function c(D){const C=f.data("dict");const E=C[CHOSEN_PACK];$(".last_step-price").text("$"+E.price);if(!USER_REGISTERED){let is_pwd_ok=x();if(!is_pwd_ok){return false}is_pwd_ok=a();if(!is_pwd_ok){return false}if(o.hasClass("is-invalid")){return false}}j(function(){if(!USER_REGISTERED){b(D)}else{D()}if(parseInt(E.price)===0){VPN_FREE=true;$(".need_payment").hide();$(".free_payment").show();$(".trial_payment").hide()}else{if(E.is_trial&&VPN_TRIAL){$(".need_payment").hide();$(".free_payment").hide();$(".trial_payment").show();$(".trial_days").text(E.trial_period_days);$(".last_step-price").text("$0.00")}else{$(".need_payment").show();$(".free_payment").hide();$(".trial_payment").hide()}}});analytics_checkout_step(2,"account","ENTERED_ACCOUNT")}$(window).keydown(function(C){if(C.keyCode===13){C.preventDefault();return false}});s.on("submit",function(C){analytics_action("order_form_submit");C.preventDefault();if(VPN_FREE!==true&&VPN_TRIAL!==true){let paymentMethodVal=$.trim($("#payment_method").val());if(!paymentMethodVal||paymentMethodVal===""){$("#payment-method-error").show();return false}}let that=this;blockPage(null,function(){$(that).ajaxSubmit({success:function(D){if(D.success){setToLocalStorage(LS_ORDER_KEY,null);setToLocalStorage(LS_ORDER_KEY,null);setToLocalStorage(LS_ORDER_PACK_ID_KEY,null);setToLocalStorage(LS_ORDER_ACCOUNT_KEY,null);setToLocalStorage(LS_ORDER_ACCOUNT_EMAIL_KEY,null);setToLocalStorage(LS_ORDER_ACCOUNT_PASSWORD_KEY,null);setToLocalStorage(LS_ORDER_ACCOUNT_PASSWORD_CONFIRM_KEY,null);window.location=m.data("url")}else{if(D.hasOwnProperty("errors")){showErrors(D)}unblockPage()}},error:function(D){console.log(JSON.stringify(D));notyError("error");unblockPage()}})});analytics_checkout_step(3,"payment","free or trial available")});g.on("hide.bs.modal",function(C){if(g.find(".modal-body").find(".payment-method.active").length===0){return}let $activePaymentMethodClone=$(".payment-method.active").parent().clone();$activePaymentMethodClone.addClass("col-xl-2");$("#payment_methods-container").append($activePaymentMethodClone)});$(document).on("click",".payment-method",function(){$("#payment-method-error").hide();if($(this).hasClass("active")){return}$(".payment-method.active").removeClass("active");$(this).addClass("active");if(g.hasClass("show")){$("#payment_methods-container").find(".payment-method.additional").parent().remove();g.modal("hide")}$("#payment_method").val($(this).data("id"));analytics_checkout_step(3,"payment",$(this).data("id"))});o.on("focusout keyup keypress blur change",function(){b()});A.on("focusout keyup keypress blur change",function(){x();a()});n.on("focusout keyup keypress blur change",function(){a()});function j(E){const F=true;const C=function(G){if(G.hasOwnProperty("success")&&G.success){VPN_TRIAL=G.data["is_vpn_trial"]}else{VPN_TRIAL=false}if(E){E()}};const D=function(G){notyError("System Error")};doAjax(l.data("url"),l.data("method"),{},F,C,D)}function b(E){let isEmailEmpty;let emailVal=$.trim(o.val());if(emailVal===""){markInput(o,false);o.parent().find(".empty_error").show();isEmailEmpty=true;return false}else{if(emailVal.indexOf("@")===-1){markInput(o,false);o.parent().find(".empty_error").show();isEmailEmpty=true;return false}else{isEmailEmpty=false}}let data={email:emailVal};const F=true;const C=function(G){if(G.hasOwnProperty("success")&&!G.success){o.parent().find(".busy_error").show();markInput(o,false)}else{o.parent().find(".busy_error").hide();ACCOUNT_LS[LS_ORDER_ACCOUNT_EMAIL_KEY]=emailVal;ORDER_LS[LS_ORDER_ACCOUNT_KEY]=ACCOUNT_LS;setToLocalStorage(LS_ORDER_KEY,ORDER_LS);if(isEmailEmpty===false){o.parent().find(".empty_error").hide();markInput(o,true);if(E){E()}}}};const D=function(G){notyError("System Error")};doAjax(r.data("url"),r.data("method"),data,F,C,D)}function x(){const D=$.trim(A.val());const C=A.parent();if(D===""){C.find(".empty_error").show();markInput(A,false);return false}else{if(D.length<6){C.find(".empty_error").hide();C.find(".short_error").show();markInput(A,false);return false}else{C.find(".empty_error").hide();C.find(".short_error").hide();markInput(A,true);ACCOUNT_LS[LS_ORDER_ACCOUNT_PASSWORD_KEY]=D;ORDER_LS[LS_ORDER_ACCOUNT_KEY]=ACCOUNT_LS;setToLocalStorage(LS_ORDER_KEY,ORDER_LS);return true}}}function a(){const C=$.trim(A.val());const D=$.trim(n.val());if(D===""){markInput(n,false);n.parent().find(".empty_error").show();return false}if(C!==D){n.parent().find(".empty_error").hide();markInput(n,false);n.parent().find(".match_error").show();return false}else{markInput(n,true);n.parent().find(".empty_error").hide();n.parent().find(".match_error").hide();ACCOUNT_LS[LS_ORDER_ACCOUNT_PASSWORD_CONFIRM_KEY]=D;ORDER_LS[LS_ORDER_ACCOUNT_KEY]=ACCOUNT_LS;setToLocalStorage(LS_ORDER_KEY,ORDER_LS);return true}}function v(){const C=f.data("json");let subsObj={};for(let i=0;i<C.length;i++){const E=C[i];const D=E.id;subsObj[D]=E}f.data("dict",subsObj);USER_REGISTERED=!!e.val();ORDER_LS=getFromLocalStorage(LS_ORDER_KEY);CHOSEN_PACK=-1;w();h(function(){if(!CHOSEN_PACK||CHOSEN_PACK===-1){$("#pack-fieldset").fadeIn("slow")}else{let chosenSubDict=subsObj[CHOSEN_PACK];analytics_begin_checkout(CHOSEN_PACK,chosenSubDict.name,"order_page",chosenSubDict.type_id,chosenSubDict.price,0);z.val(CHOSEN_PACK);d(CHOSEN_PACK,function(){p("right")})}unblockPage();analytics_action("order_init_completed")})}function h(C){$.ajax({url:t.data("url"),method:t.data("method"),async:false,dataType:"html",success:function(D){UNDERSCORE_CHOSEN_SUB_TMPLT=_.template(D);if(C){C()}},error:function(D){console.log(D)}})}function w(){if(ORDER_LS){ACCOUNT_LS=ORDER_LS[LS_ORDER_ACCOUNT_KEY]}else{ORDER_LS={}}if(!ACCOUNT_LS){ACCOUNT_LS={}}if(!USER_REGISTERED){if(ORDER_LS){CHOSEN_PACK=ORDER_LS[LS_ORDER_PACK_ID_KEY];if(ACCOUNT_LS){if(ACCOUNT_LS.hasOwnProperty(LS_ORDER_ACCOUNT_EMAIL_KEY)){o.val(ACCOUNT_LS[LS_ORDER_ACCOUNT_EMAIL_KEY]);b()}if(ACCOUNT_LS.hasOwnProperty(LS_ORDER_ACCOUNT_PASSWORD_KEY)){A.val(ACCOUNT_LS[LS_ORDER_ACCOUNT_PASSWORD_KEY]);x()}if(ACCOUNT_LS.hasOwnProperty(LS_ORDER_ACCOUNT_PASSWORD_CONFIRM_KEY)){n.val(ACCOUNT_LS[LS_ORDER_ACCOUNT_PASSWORD_CONFIRM_KEY]);a()}}}}CHOSEN_PACK=y()}function y(){let chosenPack;if(window.location.href.indexOf("pack=")!==-1){chosenPack=getUrlParameter("pack");if(isLocalStorageSupported()){ORDER_LS[LS_ORDER_PACK_ID_KEY]=chosenPack;setToLocalStorage(LS_ORDER_KEY,ORDER_LS)}z.val(chosenPack);return chosenPack}if(isLocalStorageSupported()){chosenPack=ORDER_LS[LS_ORDER_PACK_ID_KEY]}if(!chosenPack){chosenPack=z.val()}z.val(chosenPack);return chosenPack}function d(G,E){let data={service_id:G};const F=true;const C=function(H){if(!H.hasOwnProperty("success")||!H.success){showErrors(H)}else{if(isLocalStorageSupported()){ORDER_LS[LS_ORDER_PACK_ID_KEY]=G;setToLocalStorage(LS_ORDER_KEY,ORDER_LS)}if(!G){G=z.val()}E()}};const D=function(H){notyError("System Error")};doAjax(q.data("url"),q.data("method"),JSON.stringify(data),F,C,D)}});